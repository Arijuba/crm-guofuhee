<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GUOFUHEE CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #001f33; --accent-green: #00d29d; --glow-green: rgba(0, 210, 157, 0.3); --white: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: #00111a; margin: 0; padding: 0; display: flex; justify-content: center; color: var(--white); overflow-x: hidden; }
        .glow-1 { position: fixed; width: 300px; height: 300px; background: var(--accent-green); filter: blur(120px); border-radius: 50%; top: -100px; right: -100px; opacity: 0.2; z-index: 0; }
        .glow-2 { position: fixed; width: 400px; height: 400px; background: #003a5d; filter: blur(100px); border-radius: 50%; bottom: -150px; left: -150px; opacity: 0.4; z-index: 0; }
        .container { width: 100%; max-width: 600px; min-height: 100vh; background: rgba(0, 31, 51, 0.8); backdrop-filter: blur(20px); padding: 25px; box-sizing: border-box; position: relative; z-index: 1; border-left: 1px solid rgba(0, 210, 157, 0.2); border-right: 1px solid rgba(0, 210, 157, 0.2); }
        .header-area { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .logo-dot { width: 12px; height: 12px; background: var(--accent-green); border-radius: 50%; box-shadow: 0 0 15px var(--accent-green); }
        h1 { font-size: 22px; font-weight: 800; margin: 0; text-transform: uppercase; letter-spacing: 2px; }
        .menu { display: flex; background: rgba(0,0,0,0.4); border-radius: 15px; padding: 4px; margin-bottom: 20px; }
        .menu button { flex: 1; padding: 14px; border: none; cursor: pointer; border-radius: 12px; font-weight: 600; background: transparent; color: var(--white); font-size: 13px; transition: 0.3s; }
        .menu button.active { background: var(--accent-green); color: #001f33; box-shadow: 0 0 15px var(--glow-green); }
        .search-section { background: rgba(0, 210, 157, 0.05); padding: 15px; border-radius: 15px; margin-bottom: 20px; display: none; border: 1px solid var(--accent-green); }
        label { display: block; font-size: 10px; font-weight: 700; color: var(--accent-green); text-transform: uppercase; margin-top: 15px; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; background: rgba(0,0,0,0.3); color: white; font-size: 16px; outline: none; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-main { width: 100%; padding: 18px; background: transparent; color: var(--accent-green); border: 2px solid var(--accent-green); border-radius: 50px; margin-top: 30px; font-size: 15px; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .btn-main:hover { background: var(--accent-green); color: #001f33; box-shadow: 0 0 25px var(--accent-green); }
        #status { text-align: center; margin-top: 20px; font-weight: 600; color: var(--accent-green); min-height: 20px; font-size: 12px; }
        @media (max-width: 480px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="glow-1"></div><div class="glow-2"></div>
    <div class="container">
        <div class="header-area"><div class="logo-dot"></div><h1>GUOFUHEE CRM</h1></div>
        
        <div class="menu">
            <button id="t1" class="active" onclick="mode('create')">NOVO REGISTRO</button>
            <button id="t2" onclick="mode('update')">ATUALIZAR OP</button>
        </div>

        <div id="searchBar" class="search-section">
            <label>Localizar OP ou Empresa</label>
            <input list="listaDeOPs" id="idBusca" placeholder="Digite para buscar...">
            <datalist id="listaDeOPs"></datalist>
            <button onclick="buscar()" class="btn-main" style="margin-top: 10px; padding: 10px;">BUSCAR DADOS</button>
        </div>

        <form id="crmForm">
            <input type="hidden" name="action" id="act" value="create">
            <div class="grid">
                <div><label>Opportunity ID</label><input type="text" name="id" id="f_id" readonly placeholder="Sincronizando..."></div>
                <div><label>Status</label>
                    <select name="status" id="f_status">
                        <option value="Lead">Lead</option><option value="Qualified">Qualified</option><option value="Dealing">Dealing</option><option value="Won">Won</option><option value="Lost">Lost</option>
                    </select>
                </div>
            </div>
            <label>Company Name</label><input type="text" name="companyName" id="f_name" required>
            <div class="grid">
                <div><label>Owner</label><input type="text" name="owner" id="f_owner"></div>
                <div><label>State (UF)</label><input type="text" name="state" id="f_state"></div>
            </div>
            <div class="grid">
                <div><label>Segment</label><input type="text" name="segment" id="f_segment"></div>
                <div><label>Value</label><input type="text" name="estimatedValue" id="f_val" oninput="moeda(this)"></div>
            </div>
            <div class="grid">
                <div><label>Last Interaction</label><input type="date" name="lastInteraction" id="f_last"></div>
                <div><label>Deadline</label><input type="date" name="deadline" id="f_dead"></div>
            </div>
            <label>Drive Link</label><input type="url" name="driveLink" id="f_drive">
            <label>Note</label><textarea name="note" id="f_note" rows="3"></textarea>
            <button type="submit" class="btn-main" id="btn">SALVAR NA PLANILHA</button>
        </form>
        <div id="status">Iniciando...</div>
    </div>

    <script>
        const URL = "https://script.google.com/macros/s/AKfycbzRcaxMbybD1foVAjVXrN5I9JrHSD1aOxIfwMKIzWJPMA-jCJ9u-AQx8nHjh6Mkpfpq/exec"; // <--- COLOQUE O LINK /exec AQUI

        window.onload = () => { refresh(); list(); };

        async function refresh() {
            try {
                const r = await fetch(URL + "?action=proxima&t=" + Date.now());
                const t = await r.text();
                if(t.includes("<")) setTimeout(refresh, 2000);
                else { document.getElementById('f_id').value = t.trim(); document.getElementById('status').innerText = "Sistema Online"; }
            } catch(e) { setTimeout(refresh, 3000); }
        }

        async function list() {
            try {
                const r = await fetch(URL + "?action=listar&t=" + Date.now());
                const d = JSON.parse(await r.text());
                document.getElementById('listaDeOPs').innerHTML = d.map(i => `<option value="${i}">`).join('');
            } catch(e) {}
        }

        function mode(m) {
            const isU = m === 'update';
            document.getElementById('act').value = m;
            document.getElementById('searchBar').style.display = isU ? 'block' : 'none';
            document.getElementById('t1').className = isU ? '' : 'active';
            document.getElementById('t2').className = isU ? 'active' : '';
            if(!isU) { document.getElementById('crmForm').reset(); refresh(); }
        }

        async function buscar() {
            let v = document.getElementById('idBusca').value;
            let id = v.split(" - ")[0].trim();
            document.getElementById('status').innerText = "Buscando...";
            try {
                const r = await fetch(URL + "?action=buscar&id="+id);
                const res = JSON.parse(await r.text());
                if(res.found) {
                    document.getElementById('f_id').value = id;
                    document.getElementById('f_name').value = res.companyName;
                    document.getElementById('f_owner').value = res.owner;
                    document.getElementById('f_status').value = res.status;
                    document.getElementById('f_state').value = res.state;
                    document.getElementById('f_segment').value = res.segment;
                    document.getElementById('f_val').value = res.estimatedValue;
                    document.getElementById('f_last').value = res.lastInteraction;
                    document.getElementById('f_dead').value = res.deadline;
                    document.getElementById('f_drive').value = res.driveLink;
                    document.getElementById('f_note').value = res.note;
                    document.getElementById('status').innerText = "✅ Dados Carregados";
                }
            } catch(e) { document.getElementById('status').innerText = "❌ Erro na busca"; }
        }

        function moeda(i) {
            let v = i.value.replace(/\D/g,'');
            v = (v/100).toFixed(2).replace(".", ",").replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,").replace(/(\d)(\d{3}),/g, "$1.$2,");
            i.value = v ? "R$ " + v : "";
        }

        document.getElementById('crmForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            document.getElementById('btn').disabled = true;
            document.getElementById('status').innerText = "Enviando...";
            try {
                await fetch(URL, { method: "POST", mode: "no-cors", body: JSON.stringify(Object.fromEntries(new FormData(this))) });
                document.getElementById('status').innerText = "✅ Salvo com Sucesso!";
                this.reset();
                setTimeout(() => { mode('create'); refresh(); list(); }, 2000);
            } catch(e) { document.getElementById('status').innerText = "❌ Erro ao Salvar"; }
            document.getElementById('btn').disabled = false;
        });
    </script>
</body>
</html>
